<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Mermaid Builder – live, colours, shapes, icons</title>

<!-- Mermaid 10.9.1 – works over file:// and GitHub Pages -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>

<style>
body{font-family:system-ui,sans-serif;margin:1.2rem}
h1{margin-bottom:.8rem}
section{margin-bottom:1rem}
#mindmap-editor .node{margin-left:1rem;display:flex;align-items:center;gap:.4rem;margin-top:.3rem}
#mindmap-editor input{width:18rem}
#preview-box{border:1px solid #ddd;padding:.8rem;border-radius:6px}
#toolbar button{margin:0 .25rem .25rem 0;padding:.1rem .35rem;border:1px solid #ccc;border-radius:4px;cursor:pointer;font-size:.9rem}
#toolbar button.color{width:1.25rem;height:1.25rem;border:none}
</style>
</head>
<body>
<h1>Mermaid Builder</h1>

<!-- Mode & root ------------------------------------------------->
<section id="controls">
  <label for="mode">Diagram mode:</label>
  <select id="mode">
    <option value="mindmap">Mind-map</option>
    <option value="flowchart">Flowchart</option>
    <option value="timeline">Timeline</option>
  </select>
  <button id="add-root">Add root</button>
</section>

<!-- Toolbar ----------------------------------------------------->
<section id="toolbar">
  <strong>Colours:</strong>
  <button class="color" data-color="red"    style="background:#ef9a9a"></button>
  <button class="color" data-color="green"  style="background:#a5d6a7"></button>
  <button class="color" data-color="blue"   style="background:#90caf9"></button>
  <button class="color" data-color="yellow" style="background:#fff59d"></button>

  <strong>Shapes (flowchart only):</strong>
  <button data-shape="rect">[ ]</button>
  <button data-shape="rounded">( )</button>
  <button data-shape="circle">(( ))</button>
  <button data-shape="diamond">{ }</button>
  <button data-shape="hexagon">{{ }}</button>

  <strong>Icons (Font Awesome):</strong>
  <button data-icon="fa fa-balance-scale">⚖️</button>
  <button data-icon="fa fa-book">📚</button>
  <button data-icon="fa fa-university">🏛️</button>
  <button data-icon="fa fa-lightbulb-o">💡</button>
  <button data-icon="fa fa-file">📄</button>
</section>

<!-- Outline editor --------------------------------------------->
<section>
  <div id="mindmap-editor"></div>
</section>

<!-- Mermaid code box ------------------------------------------->
<section>
  <h3>Mermaid Markdown</h3>
  <textarea id="mermaid-code" rows="9" spellcheck="false"
            style="width:100%;resize:vertical"></textarea><br>
  <button id="copy-md">Copy</button>
  <button id="download-md">Download .md</button>
</section>

<!-- Live preview ----------------------------------------------->
<section>
  <h3>Preview</h3>
  <div id="preview-box"><div id="m-preview" class="mermaid"></div></div>
</section>

<script>
/* ---------- data model --------------------------------------- */
let idCounter = 0;
const roots = [];
const newNode = depth => ({
  id: `n${idCounter++}`,
  text: depth ? 'Sub-topic' : 'New Topic',
  depth,
  children: [],
  shape: 'rect',      // for flowchart mode
  color: null,
  icon: null          // Font Awesome class string
});
roots.push(newNode(0));

/* ---------- helpers ------------------------------------------ */
const $ = (sel, root = document) => root.querySelector(sel);
let currentNodeId = null;
let currentInput  = null;

/* ---------- render outline editor ---------------------------- */
function renderEditor() {
  const wrap = $('#mindmap-editor');
  wrap.innerHTML = '';
  roots.forEach(n => renderNode(n, wrap));
}
function renderNode(node, container) {
  const d = document.createElement('div');
  d.className = 'node';
  d.style.marginLeft = `${node.depth}rem`;
  d.dataset.id = node.id;

  const inp = document.createElement('input');
  inp.value = node.text;
  inp.oninput = () => { node.text = inp.value; modelChanged(); };
  inp.onfocus = () => { currentNodeId = node.id; currentInput = inp; };
  d.append(inp);

  const add = document.createElement('button');
  add.textContent = '+';
  add.onclick = () => {
    node.children.push(newNode(node.depth + 1));
    renderEditor();
    modelChanged();
  };
  d.append(add);

  container.append(d);
  node.children.forEach(c => renderNode(c, container));
}

/* ---------- serialisation helpers ---------------------------- */
const cls = c => `cls_${c}`;
const shapeWrap = (shape, lbl) => {     /* flowchart only */
  switch (shape) {
    case 'rounded': return `("${lbl}")`;
    case 'diamond': return `{${lbl}}`;
    case 'circle' : return `((${lbl}))`;
    case 'hexagon': return `{{${lbl}}}`;
    default       : return `[${lbl}]`;  // rect
  }
};
function findColours(set = new Set(), list = roots) {
  list.forEach(n => {
    if (n.color) set.add(n.color);
    findColours(set, n.children);
  });
  return set;
}

/* ---------- build Mermaid code ------------------------------- */
function toMermaid(mode) {
  if (mode === 'timeline') {
    let out = 'timeline\\n';
    roots.forEach(r => { out += `    ${r.text}\\n`; });
    return out;
  }

  /* ---- mind-map ---- */
  if (mode === 'mindmap') {
    let out = 'mindmap\\n';
    const walk = n => {
      let label = n.text + (n.color ? ':::' + cls(n.color) : '');
      out += '  '.repeat(n.depth) + label + '\\n';
      if (n.icon) {
        out += '  '.repeat(n.depth + 1) + '::icon(' + n.icon + ')\\n';
      }
      n.children.forEach(walk);
    };
    roots.forEach(walk);
    findColours().forEach(c => { out += `classDef ${cls(c)} fill:${c};\\n`; });
    return out;
  }

  /* ---- flowchart ---- */
  let out = 'graph TD\\n';
  const styles = [];
  const walk = (n, parent) => {
    out += `  ${n.id}${shapeWrap(n.shape, n.text)}\\n`;
    if (n.color) styles.push(`style ${n.id} fill:${n.color}`);
    if (parent)  out += `  ${parent.id} --> ${n.id}\\n`;
    n.children.forEach(c => walk(c, n));
  };
  roots.forEach(r => walk(r, null));
  return out + styles.map(s => '  ' + s + ';').join('\\n');
}

/* ---------- render preview ----------------------------------- */
function renderMermaid(md) {
  const tgt = $('#m-preview');
  tgt.textContent = md;
  mermaid.render('generated', md)
    .then(({ svg }) => { tgt.innerHTML = svg; })
    .catch(err  => { tgt.innerHTML =
      '<pre style="color:red">' + err.message + '</pre>'; });
}

/* ---------- model ↔ code sync -------------------------------- */
let manualEdit = false;
function modelChanged() {
  if (manualEdit) return;
  const md = toMermaid($('#mode').value);
  $('#mermaid-code').value = md;
  renderMermaid(md);
}
$('#mermaid-code').addEventListener('input', e => {
  manualEdit = true;
  renderMermaid(e.target.value);
});
function resetManual() { manualEdit = false; }

/* ---------- toolbar interaction ------------------------------ */
$('#toolbar').addEventListener('click', e => {
  if (!currentNodeId) return;
  const node = findNode(currentNodeId);

  if (e.target.dataset.color) {
    node.color = e.target.dataset.color;
    resetManual(); modelChanged(); return;
  }
  if (e.target.dataset.shape) {
    node.shape = e.target.dataset.shape;
    resetManual(); modelChanged(); return;
  }
  if (e.target.dataset.icon) {
    node.icon = e.target.dataset.icon;
    resetManual(); modelChanged();
  }
});
function findNode(id, list = roots) {
  for (const n of list) {
    if (n.id === id) return n;
    const f = findNode(id, n.children);
    if (f) return f;
  }
}

/* ---------- export & misc ------------------------------------ */
$('#copy-md').onclick = () =>
  navigator.clipboard.writeText($('#mermaid-code').value);
$('#download-md').onclick = () => {
  const blob = new Blob([$('#mermaid-code').value],
                        { type: 'text/markdown' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob), download: 'mindmap.md'
  });
  a.click(); URL.revokeObjectURL(a.href);
};
$('#add-root').onclick = () => {
  roots.push(newNode(0));
  renderEditor(); resetManual(); modelChanged();
};
$('#mode').addEventListener('change', () => {
  resetManual(); modelChanged();
});

/* ---------- start -------------------------------------------- */
mermaid.initialize({ startOnLoad: false });
renderEditor();
modelChanged();
</script>
</body>
</html>
