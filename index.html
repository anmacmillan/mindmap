<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mermaid Builder ‚Äì Indented Diagram Editor</title>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        margin: 0;
        padding: 1.5rem;
        background-color: #f4f7f9;
        color: #333;
        line-height: 1.6;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #2c3e50;
        text-align: center;
    }

    h3 {
        margin-top: 1.8rem;
        margin-bottom: 0.8rem;
        color: #34495e;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 0.3rem;
    }

    section {
        margin-bottom: 2rem;
    }

    label {
        font-weight: bold;
        margin-right: 0.5rem;
    }

    select,
    input[type="text"] {
        padding: 0.5rem 0.75rem;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 0.95rem;
        margin-right: 0.5rem;
        transition: border-color 0.2s ease-in-out;
    }

    select:focus,
    input[type="text"]:focus {
        border-color: #3498db;
        outline: none;
    }

    button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        background-color: #3498db;
        color: white;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background-color 0.2s ease-in-out;
        margin-right: 0.5rem; /* Default margin for buttons */
    }

    button:hover {
        background-color: #2980b9;
    }

    button.secondary {
        background-color: #95a5a6;
    }
    button.secondary:hover {
        background-color: #7f8c8d;
    }

    #mindmap-editor .node {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.4rem;
        padding: 0.2rem 0;
    }

    #mindmap-editor input[type="text"] {
        width: 20rem;
        max-width: calc(100% - 80px);
    }

    #mindmap-editor .node button {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
        min-width: 30px;
        background-color: #ecf0f1;
        color: #2c3e50;
        border: 1px solid #bdc3c7;
    }
    #mindmap-editor .node button:hover {
        background-color: #dfe6e9;
        border-color: #a5b1b8;
    }

    #preview-box {
        border: 1px solid #ddd;
        padding: 1rem;
        border-radius: 6px;
        background-color: #fdfdfd;
        min-height: 150px;
        overflow: auto;
    }
    #m-preview svg {
        max-width: 100%;
        height: auto;
    }

    #toolbar {
        margin-top: 1rem;
        margin-bottom: 1.5rem;
        padding: 0.8rem;
        border: 1px solid #ecf0f1;
        border-radius: 6px;
        background-color: #fafafa;
    }

    #toolbar strong {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        color: #34495e;
    }

    #toolbar button {
        margin: 0 0.3rem 0.3rem 0;
        padding: 0.3rem 0.6rem;
        font-size: 0.9rem;
    }

    #toolbar button.color {
        width: 1.8rem;
        height: 1.8rem;
        border: 1px solid #bdc3c7;
        vertical-align: middle;
        padding: 0;
    }
    #toolbar button.color.active {
        border-width: 2px;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
    }

    #mermaid-code {
        width: 100%;
        box-sizing: border-box;
        padding: 0.75rem;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 120px;
    }
    #mermaid-code:focus {
        border-color: #3498db;
        outline: none;
    }

    .action-buttons {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        body { padding: 1rem; }
        .container { padding: 1rem; }
        #mindmap-editor input[type="text"] { width: 15rem; }
        h1 { font-size: 1.8rem; }
        button { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        #toolbar button { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
        #toolbar button.color { width: 1.5rem; height: 1.5rem; }
    }
    @media (max-width: 480px) {
        #controls, #toolbar {
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        #controls label, #controls select, #controls button,
        #toolbar button {
            width: 100%; margin-right: 0; box-sizing: border-box;
        }
        #mindmap-editor .node { flex-wrap: wrap; }
        #mindmap-editor input[type="text"] {
            width: 100%; margin-bottom: 0.3rem;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>Mermaid Diagram Builder</h1>

    <section id="controls">
      <label for="mode">Diagram mode:</label>
      <select id="mode">
        <option value="mindmap">Mind Map</option>
        <option value="flowchart">Flowchart</option>
        <option value="timeline">Timeline</option>
      </select>
      <button id="add-root">Add Root Topic</button>
    </section>

    <section id="toolbar">
      <strong>Styling:</strong>
      <div>
          <span>Colors:</span>
          <button class="color" data-color="#ef9a9a" style="background:#ef9a9a" aria-label="Red"></button>
          <button class="color" data-color="#a5d6a7" style="background:#a5d6a7" aria-label="Green"></button>
          <button class="color" data-color="#90caf9" style="background:#90caf9" aria-label="Blue"></button>
          <button class="color" data-color="#fff59d" style="background:#fff59d" aria-label="Yellow"></button>
          <button class="color" data-color="#ffcc80" style="background:#ffcc80" aria-label="Orange"></button>
          <button class="color" data-color="#b39ddb" style="background:#b39ddb" aria-label="Purple"></button>
          <button class="color" data-color="" style="background:#eee; text-align: center; font-size:0.8em;" aria-label="No color">X</button>
      </div>

      <div style="margin-top: 0.5rem;">
          <span>Shapes (Flowchart only):</span>
          <button data-shape="rect">[ Rectangle ]</button>
          <button data-shape="rounded">( Rounded )</button>
          <button data-shape="circle">(( Circle ))</button>
          <button data-shape="diamond">{ Diamond }</button>
          <button data-shape="hexagon">{{ Hexagon }}</button>
      </div>

      <div style="margin-top: 0.5rem;">
          <span>Icons (Uses Font Awesome classes):</span>
          <button data-icon="fa fa-balance-scale" title="Balance Scale">‚öñÔ∏è</button>
          <button data-icon="fa fa-book" title="Book">üìö</button>
          <button data-icon="fa fa-university" title="University">üèõÔ∏è</button>
          <button data-icon="fa fa-lightbulb-o" title="Lightbulb">üí°</button>
          <button data-icon="fa fa-file-text-o" title="File">üìÑ</button>
          <button data-icon="fa fa-users" title="Users">üë•</button>
          <button data-icon="fa fa-cogs" title="Settings">‚öôÔ∏è</button>
          <button data-icon="" aria-label="No icon" title="Remove Icon">üö´ Icon</button>
      </div>
    </section>

    <section id="editor-section">
      <h3>Editor</h3>
      <div id="mindmap-editor"></div>
    </section>

    <section id="markdown-section">
      <h3>Mermaid Markdown</h3>
      <textarea id="mermaid-code" rows="12" spellcheck="false" aria-label="Mermaid code output"></textarea>
      <div class="action-buttons">
        <button id="copy-md" class="secondary">Copy Markdown</button>
        <button id="download-md" class="secondary">Download .md</button>
      </div>
    </section>

    <section id="preview-section">
      <h3>Preview</h3>
      <div id="preview-box">
        <div id="m-preview" class="mermaid" aria-live="polite"></div>
      </div>
    </section>
</div>

<script>
(function () {
    'use strict';

    /* ---------- Data Model ---------------------------------------------------- */
    let idCounter = 0;
    const roots = [];
    const newNode = (depth, text = '') => ({
        id: `node-${idCounter++}`,
        text: text || (depth === 0 ? 'New Root Topic' : 'New Sub-topic'),
        depth,
        children: [],
        shape: 'rect',
        color: null,
        icon: null
    });
    roots.push(newNode(0, 'Main Topic'));

    /* ---------- DOM Helper ---------------------------------------------------- */
    const $ = (selector, root = document) => root.querySelector(selector);
    let currentNodeId = null;
    let currentInput = null;

    /* ---------- Outline Editor Rendering -------------------------------------- */
    function renderEditor() {
        const editorContainer = $('#mindmap-editor');
        editorContainer.innerHTML = '';
        if (roots.length === 0) {
            editorContainer.innerHTML = '<p style="color: #7f8c8d;">No topics yet. Click "Add Root Topic" to begin.</p>';
        } else {
            roots.forEach(node => renderNodeUI(node, editorContainer));
        }
        updateToolbarButtonStates();
    }

    function renderNodeUI(nodeObject, parentElement) {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'node';
        nodeDiv.dataset.id = nodeObject.id;
        nodeDiv.style.marginLeft = `${nodeObject.depth * 1.8}rem`;

        const inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.value = nodeObject.text;
        inputElement.setAttribute('aria-label', `Topic text for ${nodeObject.text}`);
        inputElement.oninput = () => {
            nodeObject.text = inputElement.value;
            modelChanged();
        };
        inputElement.onfocus = () => {
            currentNodeId = nodeObject.id;
            currentInput = inputElement;
            updateToolbarButtonStates();
        };
        nodeDiv.appendChild(inputElement);

        const addButton = document.createElement('button');
        addButton.textContent = '+';
        addButton.title = 'Add child topic';
        addButton.setAttribute('aria-label', `Add child to ${nodeObject.text}`);
        addButton.onclick = () => {
            const childNode = newNode(nodeObject.depth + 1);
            nodeObject.children.push(childNode);
            renderEditor();
            modelChanged();
            setTimeout(() => {
                const newInputElement = $(`[data-id="${childNode.id}"] input`);
                newInputElement?.focus();
            }, 0);
        };
        nodeDiv.appendChild(addButton);

        const removeButton = document.createElement('button');
        removeButton.textContent = '‚Äì';
        removeButton.title = 'Remove this topic and its children';
        removeButton.setAttribute('aria-label', `Remove topic ${nodeObject.text}`);
        removeButton.onclick = () => {
            if (confirm(`Are you sure you want to remove "${nodeObject.text}" and all its sub-topics?`)) {
                removeNodeFromModel(nodeObject.id);
                if (currentNodeId === nodeObject.id) {
                    currentNodeId = null;
                    currentInput = null;
                }
                renderEditor();
                modelChanged();
            }
        };
        nodeDiv.appendChild(removeButton);
        parentElement.appendChild(nodeDiv);
        nodeObject.children.forEach(child => renderNodeUI(child, parentElement));
    }

    function removeNodeFromModel(nodeIdToRemove, currentNodeList = roots) {
        for (let i = 0; i < currentNodeList.length; i++) {
            if (currentNodeList[i].id === nodeIdToRemove) {
                currentNodeList.splice(i, 1);
                return true;
            }
            if (currentNodeList[i].children && removeNodeFromModel(nodeIdToRemove, currentNodeList[i].children)) {
                return true;
            }
        }
        return false;
    }

    /* ---------- Mermaid Code Generation --------------------------------------- */
    const INDENTATION = '  ';
    const colorToClassName = color => `cls_${color.replace(/#/g, '')}`;
    const applyShapeToLabel = (shape, label) => {
        const safeLabel = (label.startsWith('"') && label.endsWith('"')) ? label : label.replace(/"/g, '#quot;').replace(/\n/g, '<br>');
        const shapes = {
            rounded: `(${safeLabel})`,
            diamond: `{${safeLabel}}`,
            circle: `((${safeLabel}))`,
            hexagon: `{{${safeLabel}}}`,
            rect: `[${safeLabel}]`
        };
        return shapes[shape] || `[${safeLabel}]`;
    };

    function collectUniqueColors(colorSet = new Set(), nodeList = roots) {
        nodeList.forEach(node => {
            if (node.color) colorSet.add(node.color);
            if (node.children) collectUniqueColors(colorSet, node.children);
        });
        return colorSet;
    }

    /* ---------- fixed generateMindmapMermaidCode ------------------------------ */
    function generateMindmapMermaidCode() {
        let mermaidString = 'mindmap\n';
        const classDefStrings = [];

        const allExplicitColors = collectUniqueColors();
        const shouldUseDefault =
            roots.length === 1 &&
            !roots[0].color &&
            allExplicitColors.size === 0;

        const build = node => {
            let line = INDENTATION.repeat(node.depth + 1);
            const txt = node.text.replace(/\n/g, '<br>');

            if (node.depth === 0 && roots.length === 1) {
                line += `root((${txt}))`;
                if (shouldUseDefault) line += ':::defaultRootStyle';
            } else {
                line += txt;
            }
            if (node.color) line += ':::' + colorToClassName(node.color);

            mermaidString += line + '\n';

            if (node.icon) {
                mermaidString += INDENTATION.repeat(node.depth + 2) + `::icon(${node.icon})\n`;
            }
            node.children.forEach(build);
        };

        if (roots.length) roots.forEach(build);

        allExplicitColors.forEach(c =>
            classDefStrings.push(
                `classDef ${colorToClassName(c)} fill:${c},stroke:#555,stroke-width:2px,color:#fff;`
            )
        );
        if (shouldUseDefault)
            classDefStrings.push(
                'classDef defaultRootStyle fill:#f0f0f0,stroke:#888,stroke-width:2px,color:#333;'
            );

        if (classDefStrings.length) {
            mermaidString =
                mermaidString.trimEnd() + '\n' + classDefStrings.join('\n') + '\n';
        }
        return mermaidString;
    }

    function generateTimelineMermaidCode() {
        let mermaidString = 'timeline\n';
        if (roots.length > 0) {
            roots.forEach(rootNode => {
                mermaidString += INDENTATION + rootNode.text.replace(/\n/g, '<br>') + '\n';
                const addTimelineEvents = (items, depth) => {
                    items.forEach(item => {
                        mermaidString += INDENTATION.repeat(depth) + ': ' + item.text.replace(/\n/g, '<br>') + '\n';
                        if (item.children.length > 0) addTimelineEvents(item.children, depth + 1);
                    });
                };
                addTimelineEvents(rootNode.children, 2);
            });
        }
        if (mermaidString.length > "timeline\n".length && !mermaidString.endsWith('\n')) mermaidString += '\n';
        return mermaidString;
    }

    function generateFlowchartMermaidCode() {
        let mermaidString = 'graph TD\n';
        let styleDefinitions = [];

        const buildFlowchartBranch = (node, parentNode) => {
            let currentLabel = node.text;
            let nodeDefinition;

            if (node.icon) {
                const sanitizedText = node.text.replace(/"/g, '#quot;').replace(/\n/g, '<br>');
                currentLabel = `"<i class='${node.icon}'></i> ${sanitizedText}"`;
                nodeDefinition = `    ${node.id}[${currentLabel}]`;
            } else {
                currentLabel = node.text.replace(/\n/g, '<br>');
                nodeDefinition = `    ${node.id}${applyShapeToLabel(node.shape, currentLabel)}`;
            }
            mermaidString += nodeDefinition + '\n';

            if (node.color) styleDefinitions.push(`style ${node.id} fill:${node.color},stroke:#333,stroke-width:2px,color:#fff`);

            if (parentNode) mermaidString += `    ${parentNode.id} --> ${node.id}\n`;

            node.children.forEach(childNode => buildFlowchartBranch(childNode, node));
        };

        if (roots.length > 0) roots.forEach(rootNode => buildFlowchartBranch(rootNode, null));

        if (styleDefinitions.length > 0) {
            if (mermaidString.length > "graph TD\n".length && !mermaidString.endsWith('\n')) mermaidString += '\n';
            mermaidString += styleDefinitions.map(style => '    ' + style + ';').join('\n');
            if (!mermaidString.endsWith('\n')) mermaidString += '\n';
        } else {
            if (mermaidString.length > "graph TD\n".length && !mermaidString.endsWith('\n')) mermaidString += '\n';
        }
        return mermaidString;
    }

    function convertModelToMermaid(mode) {
        if (roots.length === 0) return "graph TD\n  empty[Start by adding a root topic!]";
        switch (mode) {
            case 'timeline': return generateTimelineMermaidCode();
            case 'mindmap': return generateMindmapMermaidCode();
            case 'flowchart': return generateFlowchartMermaidCode();
            default: return 'graph TD\n  error[Unknown diagram mode selected]';
        }
    }

    /* ---------- Preview Rendering --------------------------------------------- */
    async function renderMermaidPreview(mermaidMarkdown) {
        const previewElement = $('#m-preview');
        const mermaidCodeTextarea = $('#mermaid-code');

        if (!mermaidMarkdown.trim() && roots.length === 0) {
            previewElement.innerHTML = '<p style="color: #7f8c8d;">Preview will appear here once you build a diagram or write Mermaid code.</p>';
            mermaidCodeTextarea.value = '';
            return;
        }
        mermaidCodeTextarea.value = mermaidMarkdown;
        previewElement.innerHTML = '';
        previewElement.removeAttribute('data-processed');

        try {
            const { svg, bindFunctions } = await mermaid.render('mermaid-graph-' + Date.now(), mermaidMarkdown);
            previewElement.innerHTML = svg;
            bindFunctions?.(previewElement);
        } catch (error) {
            console.error("Mermaid rendering error:", error);
            previewElement.innerHTML = `<pre style="color:red; white-space:pre-wrap;">Error rendering preview:\n${error.message || error}</pre>`;
        }
    }

    /* ---------- Model ‚Üî Textarea & Preview Sync Logic ------------------------- */
    let isManualEditInProgress = false;
    function modelChanged() {
        if (isManualEditInProgress) return;
        const currentMode = $('#mode').value;
        renderMermaidPreview(convertModelToMermaid(currentMode));
    }

    $('#mermaid-code').addEventListener('input', e => {
        isManualEditInProgress = true;
        renderMermaidPreview(e.target.value);
    });

    function resetManualEditFlagAndRefresh() {
        isManualEditInProgress = false;
        modelChanged();
    }

    /* ---------- Toolbar Event Handling ---------------------------------------- */
    function updateToolbarButtonStates() {
        const selectedNode = currentNodeId ? findNodeInModel(currentNodeId) : null;
        document.querySelectorAll('#toolbar .color').forEach(btn => {
            let isActive = false;
            if (selectedNode) {
                if (btn.dataset.color === "" && (selectedNode.color === null || selectedNode.color === "")) isActive = true;
                else if (btn.dataset.color === selectedNode.color) isActive = true;
            } else {
                if (btn.dataset.color === "") isActive = true;
            }
            btn.classList.toggle('active', isActive);
        });
    }

    $('#toolbar').addEventListener('click', e => {
        if (!currentInput && !currentNodeId) return;
        const targetNode = findNodeInModel(currentNodeId);
        if (!targetNode) return;

        let modelDidChange = false;
        const dataValue = e.target.dataset;

        if (dataValue.color !== undefined) {
            targetNode.color = dataValue.color === "" ? null : dataValue.color;
            modelDidChange = true;
        } else if (dataValue.shape) {
            targetNode.shape = dataValue.shape;
            modelDidChange = true;
        } else if (dataValue.icon !== undefined) {
            targetNode.icon = dataValue.icon === "" ? null : dataValue.icon;
            modelDidChange = true;
        }

        if (modelDidChange) {
            resetManualEditFlagAndRefresh();
            renderEditor();
            currentInput?.focus();
        }
    });

    function findNodeInModel(idToFind, nodeList = roots) {
        for (const node of nodeList) {
            if (node.id === idToFind) return node;
            const found = findNodeInModel(idToFind, node.children);
            if (found) return found;
        }
        return null;
    }

    /* ---------- Export / Misc Event Handlers ---------------------------------- */
    $('#copy-md').onclick = () => {
        navigator.clipboard.writeText($('#mermaid-code').value)
            .then(() => alert('Mermaid Markdown copied to clipboard!'))
            .catch(err => {
                console.error('Failed to copy Markdown: ', err);
                alert('Failed to copy Markdown. See console for details.');
            });
    };

    $('#download-md').onclick = () => {
        const markdownContent = $('#mermaid-code').value;
        const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
        const link = document.createElement('a');
        const diagramMode = $('#mode').value || 'diagram';
        const timestamp = new Date().toISOString().slice(0, 10);
        link.href = URL.createObjectURL(blob);
        link.download = `${diagramMode}-export-${timestamp}.md`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    };

    $('#add-root').onclick = () => {
        roots.push(newNode(0));
        resetManualEditFlagAndRefresh();
        renderEditor();
        setTimeout(() => {
            if (roots.length > 0) {
                const newRootNodeId = roots[roots.length - 1].id;
                $(`[data-id="${newRootNodeId}"] input`)?.focus();
            }
        }, 0);
    };

    $('#mode').addEventListener('change', () => resetManualEditFlagAndRefresh());

    /* ---------- Initialization ----------------------------------------------- */
    mermaid.initialize({ startOnLoad: false });
    renderEditor();
    modelChanged();
})();
</script>
</body>
</html>
