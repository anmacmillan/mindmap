<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mermaid Diagram Builder</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

<!--  CSS unchanged from previous version – cut for brevity  -->
<style>
/* … same CSS as before … */
</style>
</head>
<body>
<div class="container">
  <h1>Mermaid Diagram Builder</h1>

  <!---- Controls -->
  <section id="controls">
    <label for="mode">Diagram mode:</label>
    <select id="mode">
      <option value="mindmap">Mind map</option>
      <option value="flowchart">Flow-chart</option>
      <option value="timeline">Timeline</option>
    </select>
    <button id="add-root">Add root topic</button>
  </section>

  <!---- Toolbar -->
  <section id="toolbar">
    <strong>Shapes:</strong>
    <button data-shape="square">[ Square ]</button>
    <button data-shape="rounded">( Rounded )</button>
    <button data-shape="circle">(( Circle ))</button>
    <button data-shape="bang">&gt; Bang &lt;</button>
    <button data-shape="cloud">) Cloud (</button>
    <button data-shape="hexagon">{{ Hexagon }}</button>
  </section>

  <!---- Editor / Markdown / Preview -->
  <section id="editor-section"><h3>Editor</h3><div id="mindmap-editor"></div></section>
  <section id="markdown-section">
    <h3>Mermaid Markdown</h3>
    <textarea id="mermaid-code" rows="12" spellcheck="false"></textarea>
  </section>
  <section id="preview-section">
    <h3>Preview</h3>
    <div id="preview-box"><div id="m-preview" class="mermaid" aria-live="polite"></div></div>
  </section>
</div>

<script>
(() => {
  /* ---------- basic model ---------- */
  let idCounter = 0;
  const roots = [createNode(0, 'Main topic')];
  function createNode(depth, text = '') {
    return { id: `n${idCounter++}`, text, depth, children: [], shape: 'square' };
  }

  /* ---------- util ---------- */
  const $ = (sel, root = document) => root.querySelector(sel);
  let currentNodeId = null, currentInput = null;

  /* ---------- editor ---------- */
  function renderEditor() {
    const box = $('#mindmap-editor'); box.innerHTML = '';
    roots.forEach(n => renderNode(n, box));
  }
  function renderNode(node, parent) {
    const row = document.createElement('div');
    row.className = 'node'; row.style.marginLeft = `${node.depth * 1.8}rem`;
    row.dataset.id = node.id;

    const inp = document.createElement('input');
    inp.value = node.text;
    inp.oninput = e => { node.text = e.target.value; update(); };
    inp.onfocus = () => { currentNodeId = node.id; currentInput = inp; };
    row.appendChild(inp);

    const addBtn = document.createElement('button');
    addBtn.textContent = '+'; addBtn.onclick = () => {
      node.children.push(createNode(node.depth + 1, 'Sub-topic'));
      renderEditor(); update();
      setTimeout(() => row.nextSibling?.querySelector('input')?.focus());
    };
    row.appendChild(addBtn);

    const delBtn = document.createElement('button');
    delBtn.textContent = '–'; delBtn.onclick = () => {
      if (!confirm(`Delete “${node.text}”?`)) return;
      removeNode(node.id); renderEditor(); update();
    };
    row.appendChild(delBtn);

    parent.appendChild(row);
    node.children.forEach(c => renderNode(c, parent));
  }
  function removeNode(id, list = roots) {
    for (let i = 0; i < list.length; ++i) {
      if (list[i].id === id) return !!list.splice(i,1);
      if (removeNode(id, list[i].children)) return true;
    }
    return false;
  }
  function findNode(id, list = roots) {
    for (const n of list) { if (n.id === id) return n;
      const f = findNode(id, n.children); if (f) return f; }
  }

  /* ---------- toolbar ---------- */
  $('#toolbar').onclick = e => {
    if (!currentNodeId) return;
    const {shape} = e.target.dataset; if (!shape) return;
    findNode(currentNodeId).shape = shape;
    renderEditor(); update(); currentInput?.focus();
  };

  /* ---------- Mermaid generation ---------- */
  function shapeWrap(shape, txt) {
    switch (shape) {
      case 'rounded': return `(${txt})`;
      case 'circle' : return `((${txt}))`;
      case 'hexagon': return `{{${txt}}}`;
      case 'bang'   : return `>${txt}<`;
      case 'cloud'  : return `)${txt}(`;
      default       : return `[${txt}]`; // square
    }
  }
  function genMindmap() {
    let out = 'mindmap\n';
    const emit = n => {
      out += '  '.repeat(n.depth + 1) + shapeWrap(n.shape, n.text) + '\n';
      n.children.forEach(emit);
    };
    roots.forEach(emit);
    return out;
  }
  function genFlowchart() { /* placeholder – unchanged */ return 'graph TD\n  A-->B\n'; }
  function genTimeline()  { /* placeholder – unchanged */ return 'timeline\n  section\n'; }

  function update() {
    const mode = $('#mode').value;
    const md = mode === 'mindmap' ? genMindmap()
            : mode === 'flowchart' ? genFlowchart()
            : genTimeline();
    $('#mermaid-code').value = md;
    renderPreview(md);
  }

  async function renderPreview(code) {
    const box = $('#m-preview');
    box.innerHTML = ''; box.removeAttribute('data-processed');
    try {
      const {svg, bindFunctions} = await mermaid.render('m'+Date.now(), code);
      box.innerHTML = svg; bindFunctions?.(box);
    } catch (e) {
      box.innerHTML = `<pre style="color:red">Mermaid error:\n${e.message||e}</pre>`;
    }
  }

  /* ---------- misc ---------- */
  $('#add-root').onclick = () => {
    roots.push(createNode(0, 'New root'));
    renderEditor(); update();
  };
  $('#mode').onchange = update;

  /* ---------- init ---------- */
  mermaid.initialize({startOnLoad:false});
  renderEditor(); update();
})();
</script>
</body>
</html>
